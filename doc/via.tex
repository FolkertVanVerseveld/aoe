\documentclass{beamer}
%
% Choose how your presentation looks.
%
% For more themes, color themes and font themes, see:
% http://deic.uab.es/~iblanes/beamer_gallery/index_by_theme.html
%
\mode<presentation>
{
  \usetheme{default}      % or try Darmstadt, Madrid, Warsaw, ...
  \usecolortheme{default} % or try albatross, beaver, crane, ...
  \usefonttheme{default}  % or try serif, structurebold, ...
  \setbeamertemplate{navigation symbols}{}
  \setbeamertemplate{caption}[numbered]
} 

% inputenc moet voor babel, anders krijgen we problemen met diacretics
\usepackage[utf8]{inputenc}
\usepackage[english,vietnamese]{babel}
\usepackage[T1]{fontenc}
\usepackage{hyperref, pdfpages}

\title[Preserving and opensourcing RTS video games]{Porting Age of Empires}
\author{Folkert van Verseveld}
\institute{University of Amsterdam}
\date{\today}

\begin{document}

%% ---

\begin{frame}
  \titlepage
\end{frame}

%% ---

\begin{frame}
	\begin{figure}
	\includegraphics[width=0.7\linewidth]{images/aoe_cover.jpg}
	\end{figure}

\end{frame}

%% ---

\begin{frame}
	\begin{figure}
	\includegraphics[width=0.9\linewidth]{images/website.png}
	\end{figure}

\end{frame}

\begin{frame}{Outline}
	\tableofcontents
\end{frame}

%% ---

\section{Introduction}

\begin{frame}{Introduction}
	\begin{itemize}
		\item Folkert likes oldskool and vintage soft- and hardware
		\item Tinkering with computers since 2 years old (i.e. 23 years)
		\item 19 years programming experience
		\item Lots of unfinished projects (this is one of them)
		\item In june 2016, had to quit studying Computer Science due to various reasons and restarted in september at UvA
		\item Lots of free time at hands, so why not port my all time favorite RTS game?
		\item Working on and off the project since september 2016
		\item Several thousands hours of work (rough estimate)
		\item And after all this time... AoE remake is still incomplete!
	\end{itemize}
\end{frame}

% ---

\subsection{Timeline}

\begin{frame}{Timeline}
	\begin{itemize}
		\item[2016] Project setup, gathering documentation, reverse engineering
		\item[2017] Writing DRS tools, UI stack, reverse engineering graphics
		\item[2017-04] Reverse engineering SLP, joined OpenAge team
		\item[2017-08] Project stalled: hacking on C64, gathering more documentation
		\item[2018-09] Completed in-game graphics
		\item[2018-12] Project stalled: Still recovering from X18
		\item[2019-04] TTF rendering hell, cursing at libfreetype
		\item[2019-06] Figured out SCN compression
		%\item[2019-08] Asked to join Genie-Reverse team
		\item[2019-11] TTF solution found
		\item[2020] Rewrite engine and server from scratch
		\item[2020-01] Joined Genie-Reverse team
		\item[2020-] HD-support, Multiplayer mode, \dots
	\end{itemize}
\end{frame}

% ---

\begin{frame}{Why hasn't AoE been completely opensourced yet?}
	\begin{itemize}
		\item No real need to: still runs on Windows 10 and Wine
		\item Difficult to port: around 400.000 lines of C++/C/assembly
		\begin{itemize}
			\item Technical challenges: propietary file formats, undocumented behavior, \dots
			\item Several things have only been partially figured out
		\end{itemize}
		\item Community
		\begin{itemize}
			\item[Fragmented] 10+ groups are trying to opensource AoE: 3 are still active
			\item[Cooperation] completely different goals and toolchains
		\end{itemize}
		\item Legal issues
		\begin{itemize}
			\item[IP] Microsoft/Ensemble Studios still own rights to product
			\item[Licensing] can't resell directly
			\item[Solution] same approach as OpenTTD, OpenRCT, \dots
		\end{itemize}
	\end{itemize}

\end{frame}

% ---

\subsection{20+ years of AoE}

\begin{frame}{Has AoE aged well?}
	\begin{itemize}
		\item Many sequels/expansions (AoE II) and reboots on steam etc.
		\item Arguably one of the longest and most successful RTS games of all time
		\item Horrible path-finding
		\item Stupid A.I. moments
		\item Couple of bugs (at least less than Definitive Edition)
		\begin{itemize}
			\item[Useful] blocking enemy-units, training more units than allowed
			\item[Annoying] save file corruption for projectiles (AFAIK only in 1.0c)
		\end{itemize}
	\end{itemize}

\end{frame}

% ---

\begin{frame}{Why port AoE?}
	\begin{itemize}
		\item No real need to: still runs on Windows 10 and Wine
		\item Extremely challenging and timeconsuming as a one-man-project
		\item Community
		\begin{itemize}
			\item Deserves open-source version
			\item Microsoft's Definitive Edition sucks
			\item We need mod support
		\end{itemize}
	\end{itemize}
\end{frame}

% ---

\begin{frame}{Alive and kicking}
	Chim Sẻ Đi Nắng tái đấu Shen Long thể loại 2vs2

	\begin{figure}
	\includegraphics[width=0.85\linewidth]{images/gamesao_2vs2.jpg}
	\end{figure}

\end{frame}

% ---

\begin{frame}{Alive and kicking}
	\begin{itemize}
		\item Still being played/streamed all over the world on Voobly, YouTube, Twitch, \dots
		\item Quite popular in Vietnam: \url{https://youtu.be/6T2CmWY6nd4?t=3036}
		\item Definitive Edition released on 20-02-2018 and... it's not so good:
		\href{https://steamcommunity.com/id/youshallnothash/recommended/1017900/}{Steam review},
		\url{https://www.youtube.com/watch?v=4g9F-pGQOco}
		% 59:36 unit blocking with buildings
	\end{itemize}

\end{frame}

% ---

\section{History}

\subsection{Dawn of Man}

\begin{frame}{History of AoE}
	\begin{figure}
	\includegraphics[width=\linewidth]{images/dawn_of_man.jpg}
	\end{figure}
\end{frame}

% ---

\begin{frame}{Dawn of Man}
	\begin{itemize}
		\item TRIBE engine
		\item Tony \& Rick Goodman and Bruce C. Shelley
		\item Civilisation-like style
		\item Project started around 1995
		\item Old alpha version preserved by Strong Museum of Play curators Andrew Borman and Lauren
		% TODO verify this
		\item Engine already uses inline assembly code for graphical subsystem
	\end{itemize}
\end{frame}

% ---

\subsection{Ensemble Studios}

\begin{frame}{History - Ensemble Studios}
	\begin{itemize}
		\item Worked closely together with Microsoft months before release
		\item Age of Empires released on October 15, 1997
		\item The Rise of Rome Expansion on October 22, 1998
		\item AoE was unique in its kind
		\item Many sequels released
		%\item Forgotten Empires, AoE II HD patch, \dots
	\end{itemize}
\end{frame}

% ---

\begin{frame}{History - Rise and Fall of Ensemble Studios}
	\begin{itemize}
		\item Founded in 1995 Dallas, Texas, USA
		\item Around 60 fte working on Age of Empires
		\item Microsoft acquired Ensemble Studios in 2001
		\item Peak performance with AoE II Conquerors Expansion
		\item Many ES employees left after AoE II
		\item Almost nothing completed on time
		\item Poor guidance after AoE III
		\item Closed on january 29, 2009
	\end{itemize}
\end{frame}

% ---

\begin{frame}{So what's the progress so far?}
	Community progress:
	\begin{tabular}{l|l|l|l}
		Project & Started & Collab. & Status \\ \hline
		OpenAge & 2013 & 20/140 & Basic engine \\
		*AoE remake & 2016 & 1 & Basic dummy server \\
		AoCE-I & 2017 & 6 & Renders map and some buildings \\
		GenieReverse & 2017 & 4 & Reconstructing codebase \\
		Chariot & 2017 & 7 & Basic map rendering \\ %Stalled since 2018 \\
	\end{tabular}
	(*) this is my one-man-project.

\end{frame}

% ---

\begin{frame}{So what's the progress so far?}
	Not much at the moment, but these demo's give an illustration.

	\begin{itemize}
		\item OpenAge (currently, only AoE II or later supported)
		\item Folkert's AoE remake
	\end{itemize}
\end{frame}

% ---

\begin{frame}{OpenAge - AoE II}
	\begin{figure}
	\includegraphics[width=\linewidth]{images/openage.png}
	\end{figure}
	\url{https://www.youtube.com/watch?v=4GujF6YGSBY}
\end{frame}

% ---

\section{Demo}

\begin{frame}{AoE remake}
	\begin{itemize}
		\item Still a prototype, so don't expect it to be good
		\item Hosted on \url{https://github.com/folkertvanverseveld/aoe}
		\item Server running on 159.69.33.193:25659
	\end{itemize}
\end{frame}

% ---

\section{Porting AoE}

\subsection{Goals}

\begin{frame}{AoE Remake goals}

	\begin{itemize}
		\item Replicate original game experience
		\item Redesign multiplayer from scratch
		\item Support game mods (c/lua/python, TBD)
		\item Provide tools for legacy file formats
		\item Upgrade gameplay
		\item Fix bugs in original: some useful ones may be kept/selectable
	\end{itemize}

\end{frame}

% ---

\subsection{Challenges}

\begin{frame}{How are we going to port AoE?}

	Should not be too much work right?

	\begin{itemize}
		\item We don't have any source code!
		\item Game uses (un)documented propietary file formats
		\item Lots of groups have tried this before... and failed
	\end{itemize}

\end{frame}

% ---

\begin{frame}{Porting AoE}

	\begin{itemize}
		\item Redesign multiplayer from scratch
		\item Analyze gameplay (lots of testscenarios)
		\item Figure out game specific file formats with trial and error
		\item Reverse engineer code that we can't replicate directly
	\end{itemize}

\end{frame}

% ---

\begin{frame}{What do we need?}
	\begin{itemize}
		\item Tools to read, debug (and patch) original AoE
		\item Systematic approach to reconstruct source code
		\item Tools to test replicated AoE
		\item Documentation (if there's any)
	\end{itemize}

\end{frame}

% ---

\section{Reverse Engineering}

\begin{frame}{Reverse Engineering - Overview}
	\begin{itemize}
		\item Need professional tools and Windows documentation
		\begin{itemize}
			\item[dissassembly] HexRays IDA Freeware 7.0 (or Ghidra)
			\item[documentation] MSDN and WineDocs (when MSDN sucks)
			\item[file formats] ResEdit (setup dialogs, sfx, in-game text), custom made tools
			% TODO show hidden image of authors in setup
		\end{itemize}
		\item Localization
		\item Read (and write for mods) AoE specific files
	\end{itemize}
\end{frame}

\begin{frame}{Reverse Engineering - Scenario's}
	\begin{figure}
	\includegraphics[width=\linewidth]{images/scn_re.png}
	\end{figure}
\end{frame}

% ---

\subsection{Challenges}

\begin{frame}{Reverse Engineering - Challenges}
	\begin{itemize}
		\item Documentation is dated and/or wrong
		\item Localization stored in PE DLLs: mapping, magic text
		\item x86 assembly is not pretty to read and understand
		\item Reverse engineer various Genie file formats
	\end{itemize}

	\begin{tabular}{l|l|l}
	Name & Format type & Description \\ \hline
	DRS & Data Resource Set & Uncompressed container for \\
	& & SLP, SHP, WAV, and BIN files \\
	SHP & Shape? & Bytecoded color indexed bitmap graphics \\
	SLP & SHP list & Animation of SHPs \\
	CPN & Campaign & Container for scenario's \\
	SCN & Scenario & AoE Map
	\end{tabular}

\end{frame}

% ---

\subsection{Localization}

\begin{frame}{Localization: PE file format}
	\begin{itemize}
		\item All in-game text stored in language.dll
		\item DLLs use PE format
		\item Need library to process data
		\item PE is successor to COM
		\item Designed to support graphical resources
		\item Need professional tools and Windows documentation
	\end{itemize}
\end{frame}

% ---

\begin{frame}{Localization: PE support}
	\begin{itemize}
		\item Win32 API already supports this
		\item Linux doesn't, wine does, but we don't want that
		\item pelib, but
		\begin{itemize}
			\item Only provides partial information
			\item Doesn't support text
			\item Poor performance
		\end{itemize}
		\item libpev, but:
		\begin{itemize}
			\item We need direct access to resources
			\item Inefficient for frequent use
			\item BMP poorly supported
			\item Does not support UTF16-strings properly
		\end{itemize}
		\item Windows also doesn't like cross arch DLLs
		\item So... we need to roll our own
	\end{itemize}
\end{frame}

% ---

\begin{frame}{PE file format}
	\begin{figure}
	\includegraphics[width=\linewidth]{images/pe_format.png}
	\end{figure}
\end{frame}

% ---

\begin{frame}{}
	\begin{figure}
	\includegraphics[width=0.25\linewidth]{images/pe_layout.png}
	\end{figure}
\end{frame}

% ---

\begin{frame}{}
	\begin{figure}
	\includegraphics[width=0.85\linewidth]{images/pe_restree.png}
	\end{figure}
\end{frame}

% ---

\subsection{ASMdraw}

\begin{frame}{Reverse Engineering - ASMdraw}
	When AoE was being developed, a typical developer machine had 16MB RAM and 1-2MB video RAM
	\begin{itemize}
		\item Rendering is done every frame
		\item Needs to be really fast
		\item Programwide goto's in mid-function
		\item Hand optimised code
	\end{itemize}
\end{frame}

% ---

\begin{frame}{Rendering system}
	\begin{itemize}
		\item Game graphics rendered entirely using x86 assembly: ASMdraw
		% FIXME confirm this
		\item It's really fast. Hand optimised for pentium I
		\item 16MB RAM, 1MB VRAM
		% FIXME confirm year and heritage
		\item May be inspired by 1992/5 MS-DOS VGA library
		\item Located in THIS\_COD section in PE
	\end{itemize}
\end{frame}

% ---

\begin{frame}{Reverse engineering source code using HexRays IDA}
	\begin{itemize}
		\item Can convert low-level assembly code to pseudo C
		\item Unfortunately, fails to convert some functions in ASMdraw (e.g. ASMdraw\_sprite)
		\item Still able to do code-flow analysis and investigate with debugger
	\end{itemize}
\end{frame}

% ---

\begin{frame}{HexRays IDA - Proximity view}
	\begin{figure}
	\hspace*{-10mm}
	\includegraphics[width=1.2\linewidth]{images/proximityview_asmdraw_sprite.png}
	\end{figure}
\end{frame}

% ---

\begin{frame}{HexRays IDA - Proximity view close up}
	\begin{figure}
	\hspace*{-10mm}
	\includegraphics[width=1.2\linewidth]{images/proximityview_asmdraw_sprite_branches.png}
	\end{figure}
\end{frame}

% ---

\begin{frame}{HexRays IDA - Text view}
	\begin{figure}
	\hspace*{-10mm}
	\includegraphics[width=1.2\linewidth]{images/asmdraw_sprite_x86.png}
	\end{figure}
\end{frame}

% ---

\begin{frame}{HexRays IDA - What does this code do?}
	\begin{figure}
	\hspace*{-10mm}
	\includegraphics[width=1.2\linewidth]{images/asmdraw_color_xform.png}
	\end{figure}
\end{frame}

% ---

\begin{frame}{Lessons Learned}
	\begin{itemize}
		\item Double check if something hasn't already been done/implemented before
		\item Verify that previous work is correct
		\item Always look for debug information and clues for reverse engineering
		\item Little details about tools used back when it was developed
		\item Hidden game assets
	\end{itemize}

\end{frame}

\end{document}
